#!/usr/bin/env ruby

require 'git/contest/common'
require 'trollop'
require 'highline/import'

init

sub_commands = %w()
global_opts = Trollop::options do
  stop_on sub_commands
end

# run commands
if ! git_do_no_echo 'rev-parse --git-dir'
  git_do 'init'
end

# init main
if git_contest_has_master_configured
  master_branch = git_do 'config --get git.contest.branch.master'
else
  master_branch = ask('Master branch name: ') do |q|
    q.default = 'master'
  end
end

# create develop
if git_contest_has_develop_configured
  develop_branch = git_do 'config --get git.contest.branch.develop'
else
  develop_branch = ask('Develop branch name: ') do |q|
    q.default = 'develop'
  end
end

unless master_branch != develop_branch
  throw Error 'master and develop branches should differ.'
end

prefix = ask('Prefix of sub branch name:  ') do |q|
  q.default = 'contest'
end

if git_repo_is_headless
  git_do 'symbolic-ref', 'HEAD', "\"refs/heads/#{master_branch}\""
  git_do 'commit --allow-empty --quiet -m "Initial commit"'
end

if ! git_local_branch_exists develop_branch
  git_do 'branch --no-track', develop_branch, master_branch
end

# checkout
git_do 'checkout -q', develop_branch

# save config
git_do 'config', 'git.contest.branch.master', master_branch
git_do 'config', 'git.contest.branch.develop', develop_branch
git_do 'config', 'git.contest.branch.prefix', prefix

