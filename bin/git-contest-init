#!/usr/bin/env ruby

$:.unshift File.expand_path('../../lib', __FILE__)
require 'git/contest/common'
require 'trollop'
require 'highline/import'

init

sub_commands = %w()
global_opts = Trollop::options do
  version "git-contest #{Git::Contest::VERSION} (c) 2013 Hiroyuki Sano"
  stop_on sub_commands
end

# run commands
if ! git_do_no_echo 'rev-parse --git-dir'
  git_do 'init'
end

# init main
if git_contest_has_master_configured
  master_branch = git_do 'config --get git.contest.branch.master'
else
  master_branch = ask('Master branch name: ') do |q|
    q.default = 'master'
  end
end

prefix = ask('Prefix of contest branch name:  ') do |q|
  q.default = 'contest'
end

if git_repo_is_headless
  git_do 'symbolic-ref', 'HEAD', "\"refs/heads/#{master_branch}\""
  git_do 'commit --allow-empty --quiet -m "Initial commit"'
end

# save config
git_do 'config', 'git.contest.branch.master', master_branch
git_do 'config', 'git.contest.branch.prefix', prefix

